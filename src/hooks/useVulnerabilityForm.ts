
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "@/hooks/use-toast";
import { Asset } from "@/types/asset";
import { TeamMember } from "@/types/team-member";
import { useOrganization } from "@/contexts/OrganizationContext";

export function useVulnerabilityForm() {
  const { currentOrganization } = useOrganization();
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoadingAssets, setIsLoadingAssets] = useState(true);
  const [teamMembers, setTeamMembers] = useState<TeamMember[]>([]);
  const [isLoadingTeamMembers, setIsLoadingTeamMembers] = useState(true);

  // Fetch assets for the dropdown
  useEffect(() => {
    const fetchAssets = async () => {
      if (!currentOrganization) {
        setAssets([]);
        setIsLoadingAssets(false);
        return;
      }
      
      try {
        setIsLoadingAssets(true);
        const { data, error } = await supabase
          .from('assets')
          .select('*')
          .eq('organization_id', currentOrganization.id);
        
        if (error) {
          throw error;
        }
        
        setAssets(data || []);
      } catch (error) {
        console.error('Error fetching assets:', error);
        toast({
          title: "Error loading assets",
          description: "Failed to load assets for selection",
          variant: "destructive",
        });
      } finally {
        setIsLoadingAssets(false);
      }
    };

    fetchAssets();
  }, [currentOrganization]);

  // Fetch team members for the assignee dropdown
  useEffect(() => {
    const fetchTeamMembers = async () => {
      if (!currentOrganization) {
        setTeamMembers([]);
        setIsLoadingTeamMembers(false);
        return;
      }
      
      try {
        setIsLoadingTeamMembers(true);
        const { data, error } = await supabase
          .from('team_members')
          .select('*')
          .eq('organization_id', currentOrganization.id);
        
        if (error) {
          throw error;
        }
        
        setTeamMembers(data || []);
      } catch (error) {
        console.error('Error fetching team members:', error);
        toast({
          title: "Error loading team members",
          description: "Failed to load team members for assignment",
          variant: "destructive",
        });
      } finally {
        setIsLoadingTeamMembers(false);
      }
    };

    fetchTeamMembers();
  }, [currentOrganization]);

  return { 
    assets, 
    isLoadingAssets,
    teamMembers,
    isLoadingTeamMembers
  };
}
