
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "@/hooks/use-toast";
import { Asset } from "@/types/asset";
import { TeamMember } from "@/types/team-member";
import { useAuth } from "@/contexts/AuthContext";

export function useVulnerabilityForm() {
  const { user } = useAuth();
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoadingAssets, setIsLoadingAssets] = useState(true);
  const [teamMembers, setTeamMembers] = useState<TeamMember[]>([]);
  const [isLoadingTeamMembers, setIsLoadingTeamMembers] = useState(true);

  // Fetch assets for the dropdown
  useEffect(() => {
    const fetchAssets = async () => {
      if (!user) return;
      
      try {
        setIsLoadingAssets(true);
        const { data, error } = await supabase
          .from('assets')
          .select('*')
          .eq('user_id', user.id);
        
        if (error) {
          throw error;
        }
        
        setAssets(data || []);
      } catch (error) {
        console.error('Error fetching assets:', error);
        toast({
          title: "Error loading assets",
          description: "Failed to load assets for selection",
          variant: "destructive",
        });
      } finally {
        setIsLoadingAssets(false);
      }
    };

    if (user) {
      fetchAssets();
    }
  }, [user]);

  // Fetch team members for the assignee dropdown
  useEffect(() => {
    const fetchTeamMembers = async () => {
      if (!user) return;
      
      try {
        setIsLoadingTeamMembers(true);
        
        // Using a more explicit approach with the 'as' type assertion to avoid deep type instantiation
        const result = await supabase
          .from('team_members')
          .select('id, name, email, avatar_url, role, created_at, organization_id')
          .eq('user_id', user.id);
          
        const { data, error } = result;
        
        if (error) {
          throw error;
        }
        
        // Explicitly cast the data to the TeamMember type to help TypeScript
        setTeamMembers((data || []) as TeamMember[]);
      } catch (error) {
        console.error('Error fetching team members:', error);
        toast({
          title: "Error loading team members",
          description: "Failed to load team members for assignment",
          variant: "destructive",
        });
      } finally {
        setIsLoadingTeamMembers(false);
      }
    };

    if (user) {
      fetchTeamMembers();
    }
  }, [user]);

  return { 
    assets, 
    isLoadingAssets,
    teamMembers,
    isLoadingTeamMembers
  };
}
