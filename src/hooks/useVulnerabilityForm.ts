
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "@/hooks/use-toast";
import { Asset } from "@/types/asset";
import { TeamMember } from "@/types/team-member";
import { useAuth } from "@/contexts/AuthContext";

export function useVulnerabilityForm() {
  const { user } = useAuth();
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoadingAssets, setIsLoadingAssets] = useState(true);
  const [teamMembers, setTeamMembers] = useState<TeamMember[]>([]);
  const [isLoadingTeamMembers, setIsLoadingTeamMembers] = useState(true);

  // Fetch assets for the dropdown
  useEffect(() => {
    const fetchAssets = async () => {
      if (!user) return;
      
      try {
        setIsLoadingAssets(true);
        const { data, error } = await supabase
          .from('assets')
          .select('*')
          .eq('user_id', user.id);
        
        if (error) {
          throw error;
        }
        
        setAssets(data || []);
      } catch (error) {
        console.error('Error fetching assets:', error);
        toast({
          title: "Error loading assets",
          description: "Failed to load assets for selection",
          variant: "destructive",
        });
      } finally {
        setIsLoadingAssets(false);
      }
    };

    if (user) {
      fetchAssets();
    }
  }, [user]);

  // Fetch team members for the assignee dropdown
  useEffect(() => {
    const fetchTeamMembers = async () => {
      if (!user) return;
      
      try {
        setIsLoadingTeamMembers(true);
        
        // Simpler approach to fetch team members to avoid deep type instantiation
        const { data, error } = await supabase
          .from('team_members')
          .select('id, name, email, avatar_url, role, created_at, organization_id');
        
        if (error) {
          throw error;
        }
        
        // Manually construct the TeamMember objects to ensure type safety
        const typedTeamMembers: TeamMember[] = (data || []).map(item => ({
          id: item.id,
          name: item.name,
          email: item.email,
          avatar_url: item.avatar_url,
          role: item.role,
          created_at: item.created_at,
          organization_id: item.organization_id
        }));
        
        setTeamMembers(typedTeamMembers);
      } catch (error) {
        console.error('Error fetching team members:', error);
        toast({
          title: "Error loading team members",
          description: "Failed to load team members for assignment",
          variant: "destructive",
        });
      } finally {
        setIsLoadingTeamMembers(false);
      }
    };

    if (user) {
      fetchTeamMembers();
    }
  }, [user]);

  return { 
    assets, 
    isLoadingAssets,
    teamMembers,
    isLoadingTeamMembers
  };
}
